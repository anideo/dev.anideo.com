<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>com.anideo.dev - The Anideo Developers' Blog</title>
   <meta name="author" content="Anideo Dev" />
   <link href="/css/bootstrap.min.css" media="screen" rel="stylesheet" type="text/css" />
   <link href="/css/default.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/css/globals.css" media="screen" rel="stylesheet" type="text/css" />
   <link rel="alternate" type="application/atom+xml" title="McLovin - Atom" href="http://feeds.feedburner.com/anideo-dev" />
   <meta name="verify-v1" content="H2MobDzY8glD+MCbudtHDX3ln0Q8MZLhA6Qwvyv2AdE=" />
</head>
<body>

<div class="container" id="main">
  <section id="default">
    <div class="row">
      <div class="span4" id="about">
        <h1><a href="/">The Anideo Dev Blog</a></h1>
        <h2>com.anideo.dev</h2>
        <h3>The Anideo Dev Blog</h3>

        <ul class="sidebar-menu">
          <li><a href="/">Home</a></li>
          <li><a href="/archives.html">Archives</a></li>
          <li><a href="mailto:dev@anideo.com?subject=Hey Devs">Contact</a></li>
          <li><a href="http://feeds.feedburner.com/anideo-dev">Feed</a></li>
        </ul>
      </div>

      <div class="span12">
        
  <div class="post">
    <h1><a href="/2012/01/19/simple-windowing-and-ranking-on-postgres-or-a-behind-the-scenes-look-at-githeroes.html">Simple Windowing and Ranking on Postgres &ndash; Or a Behind-The-Scenes look at GitHeroes</a></h1>
<p class="meta">19 Jan 2012 &#8211; Singapore</p>
<p>I&#8217;d written this down a while ago about an app that I thought would be cool &#8211; l33tornot.com. The concept is basically centered around voting for hackers you thought were l33t &#8211; the idea was to be completely harmless and meant out of curiosity as to whom people would vote for.</p>
<p>But there were complications &#8211; who was eligible? How would you handle duplicates ? How would you avoid election fraud &#8211; authenticating with Twitter, Facebook or something else? Also how do you handle the case where a larger-than-life character overshadows your personal hero based in tiny Singapore?</p>
<p>These problems put a dampener on my efforts but I was determined not to let this idea pass &#8211; and so on New Years&#8217; Eve (after much thought for the previous two days), I decided to re-incarnate the idea as <a href="http://githero.es">GitHeroes</a>.</p>
<h2>Premise</h2>
<p>The premise was simple:</p>
<ul>
  <li>Login using GitHub</li>
  <li>Nominate your personal hero (you could nominate as many as you want)</li>
  <li>Publicize your nomination so you could get fellow hackers to vote for them</li>
  <li>Put up a leaderboard so you could see how your hero was doing</li>
</ul>
<p>This re-incarnation of the app did away with problems of deciding &#8220;canonical&#8221; objects for hackers being nominated, election fraud and seemed a much more elegant app.</p>
<h2>Behind The Scenes</h2>
<p>The app was built using Rails 3.1, CoffeeScript, Twitter Bootstrap, PostgreSQL and is hosted on Heroku. It uses <a href="https://github.com/intridea/omniauth">Omniauth</a> for GitHub OAuth integration (Omniauth by the way is a fantastic library) and with a <a href="http://www.quora.com/What-font-is-used-in-the-Github-logo">little help from Quora</a>, I even found the GitHub font so that I could design a good-enough logo.</p>
<h3>Ranking using PostgreSQL</h3>
<p>The most interesting bit for me about GitHeroes is the way the ranking/leaderboard stuff is done. I contemplated using Redis to do ranking, but I am quite wary of introducing dependencies to a Rails stack unless it&#8217;s absolutely necessary.</p>
<p>Turns out, it <strong>is</strong> unnecessary because Postgres (9.0 and above) provides with you <a href="http://www.postgresql.org/docs/9.1/static/tutorial-window.html">window functions</a> which let you run calculations across a set of rows in a table. You can choose to group similar rows together, but they also work across the entire table.</p>
<p><strong>Sidenote</strong>: Postgres 9.0 is not available on the shared database plans available on <a href="http://heroku.com">Heroku</a> so you will need to provision your own or upgrade to the paid plans.</p>
<p>How voting is designed is quite simple, here is the class:</p>
<script src="https://gist.github.com/1638263.js?file=vote.rb"></script><p>As you may notice, there is a counter-cache for the hero being voted for and the <code>votes_received</code> is incremented on Hero every time a vote is cast.</p>
<p>The <code>votes_received</code> column is then used as the column to rank while choosing heroes for the leaderboard.</p>
<p>This is the function used in the <code>Hero</code> class to get the top 20 heroes ranked by votes across all locations:</p>
<script src="https://gist.github.com/1638263.js?file=global_leaderboard.rb"></script><p>&#8230;and this is the function used to get the top 20 hereoes by votes in a given location:</p>
<script src="https://gist.github.com/1638263.js?file=leaderboard_by_location.rb"></script><p>Note: You will need to add a descending order index on votes_received, since by default btree indexes on Postgres use the ascending order:</p>
<p><code>CREATE INDEX desc_votes_recvd_idx on heros(votes_received DESC NULLS LAST);</code></p>
<p>As you can see from the query plan below, the query is quite efficient and works like a charm: (although I probably should run benchmarks against a larger table)</p>
<script src="https://gist.github.com/1638263.js?file=query_plan_for_global_leaderboard.sql"></script><h2>Conclusion</h2>
<p>GitHeroes was a fun little project that took two days to build and got to the front page of <a href="http://news.ycombinator.com/item?id=3415938">Hacker News</a>. But it also gave me a chance to explore some neat Postgres features which will be useful for the other app that we are building &#8211; <a href="http://getdenso.com">Denso</a>.</p>
    <div class="signoff">
      <a href="/2012/01/19/simple-windowing-and-ranking-on-postgres-or-a-behind-the-scenes-look-at-githeroes.html#disqus_thread">View Comments</a>
    </div>
  </div>

  <div class="post">
    <h1><a href="/2012/01/14/the-inaugural-anideo-hackathon.html">The Inaugural Anideo Hackathon</a></h1>
<p class="meta">14 Jan 2012 &#8211; Singapore</p>
<p><a href="http://twitter.com/ajhit406">AJ</a>&#8217;s been floating the idea of a regularly scheduled hackathon at Anideo for a few months now. He believes (and I concur) that we need a break from our own product building to do something outside our collective zones of comfort.</p>
<p>We finally got off our butts and managed to put one together last week. We wanted to hold it at our office and we weren&#8217;t sure what the response would be like and we didn&#8217;t want to risk overcrowding our cosy little space, so we invited a few friends over, got some pizza, stocked up on Red Bull and stayed from 7pm on a Thursday to 5am the next morning.</p>
<p>It was great fun to take off our minds off work and do something different, and it was great to talk to friends about pure tech stuff without the startup bullshit that has taken over our lives &#8211; more on that later.</p>
<p>We successfuly completed the hackathon and are proud to report on some of the projects that came up during the event:</p>
<h4>KNPathTableViewController</h4>
<p><a href="http://kentnguyen.com">Kent</a> has been taking care of our mobile needs very ably for the last few months and has been generating stellar work week over week. We&#8217;ve all ogled at Path&#8217;s new beautiful interface and Kent took it on himself to do a version of the scrolling clock which appears whenever you scroll down your Path timeline. The result of his work is <a href="https://github.com/kentnguyen/KNPathTableViewController">here</a>, free for anyone to use.</p>
<h4>underscore.cocoa</h4>
<p><a href="http://decisivebits.com">Peter</a>&#8216;s been making great contributions to the Cocoa <span class="caps">BDD</span> community over the last few weeks with <a href="https://github.com/petejkim/specta">Specta</a> as well as <a href="https://github.com/petejkim/expecta">Expecta</a>, but his work during the hackathon consisted of porting underscore.js to Cocoa. You can track his progress on GitHub <a href="https://github.com/petejkim/underscore.cocoa">here</a>. I still haven&#8217;t started doing <span class="caps">BDD</span> on Cocoa (in fact I haven&#8217;t done Cocoa programming in a while) but Peter&#8217;s set of great tools will enable me to cross the chasm.</p>
<h4>LazyPost</h4>
<p>This is still a working name but AJ came up with an idea that involves location and postcards. It&#8217;s a nifty little app and we&#8217;ll give you more details once its ready to ship (which is hopefully very soon).</p>
<h4>proxee.io</h4>
<p>I personally worked on <a href="http://proxee.io">proxee.io</a> &#8211; I want a better web debugging proxy to test out iOS app APIs. My current solution is to use Charles which is both a Java app as well as quite expensive, hence my need for proxee.io.</p>
<p><a href="http://andadinosaur.com">Zhenyi</a> helped with the design of the app and my arguments with <a href="http://choonkeat.com">Choon Keat</a> over the need for a local proxy vs a hosted one, helped sharpen my reasonings for making it. Choon Keat is in fact working on a hosted proxy which lets you rewrite responses to a server/client based on a set of rules and lets you record traces of <span class="caps">API</span> calls, which can be shared with others.</p>
<p>I don&#8217;t think I&#8217;ve convinced him yet of the need for my take on a proxy, but hopefully once it&#8217;s live! ;)</p>
<h4>Lessons</h4>
<p>I personally enjoyed the camaraderie and the arguing a lot and enjoyed working on a completely different problem than my &#8220;day job&#8221;. We need to work harder on maybe making sure that people collaborate more during the hackathons, but it was definitely a good first step.</p>
<p>Here&#8217;s to many more, so stay tuned!</p>
    <div class="signoff">
      <a href="/2012/01/14/the-inaugural-anideo-hackathon.html#disqus_thread">View Comments</a>
    </div>
  </div>

  <div class="post">
    <h1><a href="/2012/01/03/how-we-setup-amazon-cloudfront-to-play-nice-with-rails.html">How we setup Amazon Cloudfront to play nice with Rails 3.0.x on Heroku</a></h1>

<p class="meta">03 Jan 2012 - Singapore</p>

<p>As was mentioned in our <a href="http://dev.anideo.com/2011/12/30/how-moving-to-amazon-cloudfront-increased-our-app-store.html">previous post</a>, we recently started using Amazon Cloudfront for our CDN needs. We wanted the performance benefits that we would gain from the move, we certainly didn&#8217;t want it to come at the cost of speed of deployment.</p>

<p>While the CloudFront custom origin server solution takes care of deployment, there is still the problem of expiring stale assets (especially Javascript and CSS).</p>

<p>As they say, the two toughest problems in Computer Science are caching, naming things and off-by-one errors.</p>

<p><strong>Asset Fingerprinting</strong></p>

<p>The problem of expiring stale content for CDN&#8217;s (and browsers) is solved by <a href="http://guides.rubyonrails.org/asset_pipeline.html#what-is-fingerprinting-and-why-should-i-care">asset fingerprinting</a> as part of Rails 3.1&#8217;s Asset Pipelining feature.</p>

<p>Every file in the app/assets directory in Rails 3.1 is &#8220;compiled&#8221; as part of the <code>rake assets:precompile</code> Rake task and the asset fingerprint is appended to the each file&#8217;s path and copied over to public/. The asset fingerprint is an MD5 digest of the contents of each file - so if a file is changed (for e.g. and image is changed or you change something in your CSS), the MD5 of the asset will change, and hence that particular asset will be &#8216;expired&#8217;.</p>

<p>The blog post that I referenced from the <a href="http://blog.opengovernment.org/2011/02/10/cloudfront-s3-rails-and-jammit-on-apache/">Open Government</a>, uses the SHA of the most recent Git commit as the asset fingerprint. While that is a simple solution, it is quite inefficient. Think about it - any time you make a change to your site - (including model code or a change in a Rake task), your assets will be expired, even though technically the assets haven&#8217;t changed.</p>

<p>We don&#8217;t change our CSS/JS/images that often, but we do make changes to our business logic quite often (and deploy multiple times a day), so this solution won&#8217;t fly and defeats the purpose of the CDN, since content will always be expired.</p>

<p><strong>Asset Fingerprinting without Sprockets</strong></p>

<p>What we came up with is a better solution, which takes a digest of the entire public/ directory under Rails.root. It&#8217;s still less efficient than Sprockets&#8217; asset fingerprinting, since in our solution the fingerprint is a hash of the entire directory and not each file. So even if you make a change to a single file, an unrelated file under the public/ will also be expired even if it hasn&#8217;t changed.</p>

<p>The hash of the public/ directory is stored in a file called <strong>assets.fingerprint</strong> under Rails.root, and is generated like <a href="https://gist.github.com/1554094">this</a>.</p>

<p><script src="https://gist.github.com/1554094.js?file=set_asset_fingerprint.rb"></script></p>

<p>This is a function of a deploy Rake task which performs pre-flight checks such as these before pushing to Heroku.</p>

<p>We define a constant called REVISION which is defined in <code>config/initializers/asset_fingerprint.rb</code> thusly:</p>

<p><code>REVISION = File.read(Rails.root.join(&#8216;assets.fingerprint&#8217;)).strip</code></p>

<p>&#8230;and in application.rb, the assets path is prepended with the hash as part of the path.</p>

<p>We also make sure that we use Rack::Rewrite to rewrite paths to the assets to ignore the hash and that the assets host points to the Amazon CDN.</p>

<p>Our entire application.rb is here for your reference: <a href="https://gist.github.com/1554090"><a href="https://gist.github.com/1554090">https://gist.github.com/1554090</a></a>.</p>

    <div class="signoff">
      <a href="/2012/01/03/how-we-setup-amazon-cloudfront-to-play-nice-with-rails.html#disqus_thread">View Comments</a>
    </div>
  </div>

  <div class="post">
    <h1><a href="/2011/12/30/how-moving-to-amazon-cloudfront-increased-our-app-store.html">How moving to Amazon Cloudfront increased our App Store conversion rate by 250%</a></h1>

<p class="meta">30 Dec 2011 - Singapore</p>

<p>So as you may know, we&#8217;ve been working on <a href="http://bit.ly/densoapp">Denso</a> for a while now, and our primary source of marketing (after the initial wave of PR via <a href="http://facebook.com/saverin">Eduardo</a>) has been our website. We post interesting videos once in a while to Hacker News, Reddit, Twitter and Facebook, thus generating inbound traffic.</p>

<p>The <a href="http://news.ycombinator.com/item?id=3346674">Hacker News story</a> about <a href="http://getdenso.com/videos/2711806-december-08-2011-ed-gillespie-part-3">Jon Stewart&#8217;s takedown of scammy iOS games</a> generated a record number of visits to <a href="http://getdenso.com">getdenso.com</a>, but unfortunately, that number didn&#8217;t correlate well with the App Store downloads for that period. What we noticed was that our site appeared slow (even though New Relic indicated that our website stood up quite well against the onslaught) - and the reason was that our static assets (Javascript and CSS) were taking too long to load and would occasionally even 504.</p>

<p>This, was obviously, unacceptable.</p>

<p>We researched a bunch of ways on how we can improve the speed of the site, and naturally Amazon Cloudfront ranked very high among our options. But we needed a way for it not to interfere with our existing deployment strategy (which is git push heroku master). We chanced upon this <a href="http://blog.opengovernment.org/2011/02/10/cloudfront-s3-rails-and-jammit-on-apache/">excellent resource</a> which basically gives a detailed tutorial on setting up a custom origin server on CloudFront. With Heroku, its not as straightforward as the Open Government tutorial makes it out to be - there will be another blog post coming up on the tweaks that we implemented.</p>

<p><strong>Before and After</strong></p>

<p>We switched over to our shiny new CDN solution on the 16th of December.</p>

<p>Before the 16th, our App-Store-downloads-to-web-visits ratio was hovering around <strong>6-8%</strong></p>

<p>After the CDN deployment, our App-Store-downloads-to-web-visits ratio is now a healthier <strong>21-28%.</strong></p>

<p><strong>Moral Of the Story</strong></p>

<p>Obviously the moral of the story is not for everyone to move over to a CDN. A lot of other iOS app downloads are probably not driven by their web cousins, so it won&#8217;t <em><strong>always </strong></em>make sense for you to optimize web performance.</p>

<p>Our biggest takeway is - run experiments, follow up on performance, try to find out root causes for weaknesses, and ruthlessly tackle them.</p>

    <div class="signoff">
      <a href="/2011/12/30/how-moving-to-amazon-cloudfront-increased-our-app-store.html#disqus_thread">View Comments</a>
    </div>
  </div>

      </div>

    </div>
  </section>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-12521474-5");
pageTracker._trackPageview();
} catch(err) {}</script>

</body>
</html>